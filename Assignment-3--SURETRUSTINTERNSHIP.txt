-- QUERY 1 -- TOP 3 CUSTOMERS BASED ON THE AMOUNT SPENT.

SELECT C.CUSTOMER_ID, C.CUST_FIRST_NAME, C.CUST_LAST_NAME, SUM(O.ORDER_TOTAL) AS TOTAL_SPENT
FROM DEMO_CUSTOMERS C
INNER JOIN DEMO_ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
GROUP BY C.CUSTOMER_ID, C.CUST_FIRST_NAME, C.CUST_LAST_NAME
ORDER BY TOTAL_SPENT DESC
FETCH FIRST 3 ROWS ONLY;

-- QUERY 2 -- TOP 3 CUSTOMERS BASED ON THE NUMBER OF ORDERS.

SELECT C.CUSTOMER_ID, C.CUST_FIRST_NAME, C.CUST_LAST_NAME, COUNT(O.ORDER_ID) AS ORDER_COUNT
FROM DEMO_CUSTOMERS C
INNER JOIN DEMO_ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
GROUP BY C.CUSTOMER_ID, C.CUST_FIRST_NAME, C.CUST_LAST_NAME
ORDER BY ORDER_COUNT DESC
FETCH FIRST 3 ROWS ONLY;

-- QUERY 3 -- TOP 3 PRODUCTS BASED ON QUANTITY SOLD.

SELECT P.PRODUCT_ID, P.PRODUCT_NAME, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
FROM DEMO_PRODUCTS P
INNER JOIN DEMO_ORDER_ITEMS OI ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY P.PRODUCT_ID, P.PRODUCT_NAME
ORDER BY TOTAL_QUANTITY DESC
FETCH FIRST 3 ROWS ONLY;

-- QUERY 4 -- CAPTURE THE CUSTOMER'S LAST NAME, PRODUCT NAMES (BOUGHT) AND TOTAL QUANTITY OF EACH OF THEM.

SELECT C.CUST_LAST_NAME, P.PRODUCT_NAME, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
FROM DEMO_CUSTOMERS C
INNER JOIN DEMO_ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
INNER JOIN DEMO_ORDER_ITEMS OI ON O.ORDER_ID = OI.ORDER_ID
INNER JOIN DEMO_PRODUCTS P ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY C.CUST_LAST_NAME, P.PRODUCT_NAME;

-- QUERY 5 -- TRANSFORM THE ROWS TO COLUMNS FOR THE RESULT FROM QUERY #4 ABOVE.

SELECT CUST_LAST_NAME,
       MAX(CASE WHEN PRODUCT_NAME = 'PRODUCT1' THEN TOTAL_QUANTITY ELSE 0 END) AS PRODUCT1,
       MAX(CASE WHEN PRODUCT_NAME = 'PRODUCT2' THEN TOTAL_QUANTITY ELSE 0 END) AS PRODUCT2,
       MAX(CASE WHEN PRODUCT_NAME = 'PRODUCT3' THEN TOTAL_QUANTITY ELSE 0 END) AS PRODUCT3
FROM (
    SELECT C.CUST_LAST_NAME, P.PRODUCT_NAME, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
    FROM DEMO_CUSTOMERS C
    INNER JOIN DEMO_ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
    INNER JOIN DEMO_ORDER_ITEMS OI ON O.ORDER_ID = OI.ORDER_ID
    INNER JOIN DEMO_PRODUCTS P ON OI.PRODUCT_ID = P.PRODUCT_ID
    GROUP BY C.CUST_LAST_NAME, P.PRODUCT_NAME
) SUBQUERY
GROUP BY CUST_LAST_NAME;

-- QUERY 6 -- WHICH YEAR HAD THE MOST ORDERS?

SELECT EXTRACT(YEAR FROM O.ORDER_TIMESTAMP) AS ORDER_YEAR, COUNT(O.ORDER_ID) AS TOTAL_ORDERS
FROM DEMO_ORDERS O
GROUP BY EXTRACT(YEAR FROM O.ORDER_TIMESTAMP)
ORDER BY TOTAL_ORDERS DESC
FETCH FIRST 1 ROW ONLY;

-- QUERY 8 -- WHICH PRODUCT CATEGORY WAS MOST SOLD?

SELECT P.CATEGORY, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
FROM DEMO_PRODUCTS P
INNER JOIN DEMO_ORDER_ITEMS OI ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY P.CATEGORY
ORDER BY TOTAL_QUANTITY DESC
FETCH FIRST 1 ROW ONLY;

-- QUERY 9 -- WHICH PRODUCT CATEGORY TOOK THE SECOND POSITION IN TERMS OF QUANTITY SOLD?

SELECT P.CATEGORY, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
FROM DEMO_PRODUCTS P
INNER JOIN DEMO_ORDER_ITEMS OI ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY P.CATEGORY
ORDER BY TOTAL_QUANTITY DESC
OFFSET 1 ROWS FETCH FIRST 1 ROW ONLY;

-- QUERY 10 -- ROLLUP TOTAL QUANTITY ON CUSTOMER AND PRODUCT (NAME).

SELECT C.CUST_LAST_NAME, P.PRODUCT_NAME, SUM(OI.QUANTITY) AS TOTAL_QUANTITY
FROM DEMO_CUSTOMERS C
INNER JOIN DEMO_ORDERS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
INNER JOIN DEMO_ORDER_ITEMS OI ON O.ORDER_ID = OI.ORDER_ID
INNER JOIN DEMO_PRODUCTS P ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY ROLLUP (C.CUST_LAST_NAME, P.PRODUCT_NAME);
